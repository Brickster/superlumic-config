---

- hosts: all
  connection: local

  roles:
    - profile-all
    - profile-server

  vars:
    - computername: Mini
    - git_user_name: Marcus Rosenow
    - git_user_email: Brickstertwo@users.noreply.github.com

  tasks:

    # set profile picture
    - name: register Profile picture
      shell: dscl . -read "{{ lookup('env', 'HOME') }}" Picture
      register: profile_picture
      changed_when: profile_picture.stdout.find('laptop.png') == -1
    - name: install profile picture
      become: true
      copy:
        src: 'files/laptop.png'
        dest: '/Library/User Pictures'
      when: profile_picture|changed
    - name: delete JPEGPhoto setting
      shell: dscl . -delete "{{ lookup('env', 'HOME') }}" JPEGPhoto
      when: profile_picture|changed
    - name: delete Picture setting
      shell: dscl . -delete "{{ lookup('env', 'HOME') }}" Picture
      when: profile_picture|changed
    - name: set Picture setting
      become: true
      shell: dscl . -create "{{ lookup('env', 'HOME') }}" Picture '/Library/User Pictures/laptop.png'
      when: profile_picture|changed

    # set authorized SSH keys
    - name: ensure .ssh directory exists
      file:
        path: ~/.ssh
        state: directory
    - name: setup ssh
      copy:
        src: files/server/authorized_keys
        dest: ~/.ssh/authorized_keys
    - name: setup dot files
      copy:
        src: "{{item}}"
        dest: "~"
      with_items:
        - files/.profile

    - name: create SSH directory
      file: path="~/.ssh" state=directory
    - name: register github_mini_rsa stat
      stat: path="~/.ssh/github_mini_rsa"
      register: github_mini_rsa_stat
    - name: install github SSH key
      copy:
        dest: ~/.ssh/github_mini_rsa
        mode: 0600
        content: |
          $ANSIBLE_VAULT;1.1;AES256
          36326335613839313361366237663332633533613234626566333432356331356461383836303939
          3362666134623961373462336132333536303033376362660a643166353730306631656161663330
          38333964633839326233306632373030656335633930343635633165343366303836313635373137
          6131623762653932630a666332396163636664396330613935633731353338623833313435623437
          37313534313837653631393833653138343565336337376337633366306561303637323032623061
          35653966656161356531666638383961636532333433613166646564346438336337396433623562
          39306236646461353039636263383064323336333464643862313737613432656237316433313737
          37643032613163653138616438393365663564323861336439313039393166656466303163633836
          37653536313033656138363566623662326361613934316561373235363362666132613661366330
          31633533613639383833663261616631383038336461643038636637393531313534333532366231
          39386564393434656362346261303336663564336536323637336564353734306432656536343935
          37383837663639363135363263613534656161376436346431313862353066303365626166323634
          31373531373966656662633735653264383531396237376665313935646330646565663164393939
          61343539356436663364666433313837633638666536616266613765616134363739663664313861
          64303638343363386564316334396464363937663134313064656235356161663965366136343839
          30316539333837663666303738346432633965383434323365356136613366373161353536626537
          30653932616336613961313662393537613466393865326137333136303833323739393261343366
          63643133653161353566373137623734353861373232333432633963393330633834646566653734
          66306366303735386234366436373039643437373462303162386231653862623966306337666563
          37623363303361326233323232633237353434626666376465646430396461346166336439353366
          36356634333434336331306230666563386431656439376364396638343737633231383534373631
          65616438336434333433663135646236633434386432643235613666336666643964643538316235
          32653466653435306262623265336531346663343939633438636236643235666630353037313431
          66656137613635656166396565646136303131396238363661356662326464333561393134353265
          30666564656433343634383466373237353633353563653039396666353266653164663934633035
          32646532363739323631386235303864336130343234613538393865376266666631623166643466
          37643961653833653035333132346637356636336238663436323866306239393166346132353032
          62316332373563393037383137336434333833373964383634356132613433323432353365303932
          66303937393135646362663031393133303565626332646235346139643066323730633737316238
          66363438346264316634336135386563303239333539353032376364306535383461346636333830
          61653636643639326462643532363863316662643435616461613731666439323831623633356231
          35613133383230333764653265626639363839636261636363643361386133323165363736333161
          33653538643335613265613665656238313664633963373966616361363039623036333862636461
          35396666636366633634323532666133613439383437343539326330313330366230303230333233
          65383930626662656366316338386431363234333534633138346334613465316431353030343463
          62393631666563393138383861336366373731643532666566386637656662356534646634636531
          61653434353637336161303437326362623961346439313333663564623831626338376135343134
          31316663666133653038616335653265366631626634323939366661663433336264376238646539
          36633836353462396136623335383236663430613966316463306164376439316238663635643764
          37333839353430346364366633636231656565643936313861383262376233663535383366383834
          35323133323264383435656532396338373735353637633731626434633038653935633731343166
          37306138396637663662313036323535633532306364666664623464643562616664633739353436
          30663533366136336531636636306231303131343036373131383836383437366337396133336666
          35313338323238346663636631376163663433353832616461343664313264336437643866656538
          38613061363561353433653962333837353766383932613832666632346165386166656164663232
          39613030643930303631663263323536393135613836313438363233356166626135306162373461
          33353433326132613930393330636434396366353438366135346431336138383637663837353333
          39616439623265323132313938373239313639633865353031353135373530663531373461313436
          39323563343535323639653639616136373434306534633137633230626336623631356164343033
          32393934373234653535313932376534323433646332623162306637666233336637653531303837
          31653838363231363565653632353736353364323538353433303733666636323236366432373332
          32663733653938643632633162363363666563373731316665353334396666343232633034633737
          36663462633332303332323665663264303263343861653834613736663034326433366433643736
          34306331313935663532636366373232643937633430336666366635313034656637376239313761
          38323534626134613034343166393762353636316539353061326332356462373962343165333430
          33383933613636646164313236336238333739356232663531313161653231356430386264626266
          62636266313331663336626330353134346464613937633730363732306334373837386531313464
          39666263663233623535346637336433353634326137373936613263623933323830613333373732
          64633762653266653134393936343830323538666138316665616433323335323662336464303865
          36333432356361646338643162323934316531616465356164373831623237616330336434376465
          63376465336234363134393337383739653739636530653865313233386136303563353662323866
          61333263353761643735356131396462336666383532316265346538663438663239373637373161
          35346132663964356536393336323664386563613433633030383133363733653932333061656636
          66663333333130646337343565313964343332313133396631386534353333626330336433613365
          35653266663766333832633534323261623035633738356465333835343430326339613539383035
          39373531383165366133373064383561306436636464633832343363663634386234663038663463
          65353932616662633738616661396534326263386432613838373863383237373437353838363864
          31376237643834376561663235343662363436336430623932623334333232343965663265663162
          35363432386631363638313839356361373138333933376466613431336163373065313564653665
          61316136383632396436656566393036336136383835643031353365333166656431393266613232
          62613231616666656431363031643032643736363033323638616532316161323863333139333766
          38633937343865666563646436643365343537306339633439393732653566363637363734303661
          30383765393233356635376662373266373734303836393063313966353132633263366334333435
          61376166316331303038363730323462316531323434323334616230623235396464363632313231
          37346235316363396262336231656461376638323165656135633963363036346265303337373931
          66643438393832393538663563313531636136363966313566313832303932663564316333396135
          39646132313064346662653032323330386365346333303236633262656233343236373066633134
          38666462383364343537343835303837323637376562353166643438666431363737363731653134
          63313166343835663739386331383261323034383535363039393861663566303862633130333536
          64313739363536306632666537386365613735613232373331633264383836336663636265376534
          63326665393339613661376131613133313736373838383838373138316138616564363636356530
          66623561656230616266353631613063633631663061643235623630616334306262323035393664
          65303930313437346234396531396437316130383061316339663261653662663536656530333537
          64343564613164656262306263326536653731393633336336313030303032626631323937336238
          38633032623630313633643563366630346233633865626465626162633865383436616633353432
          30336236326563613533303039303736646138626433316331386630656566356536623434623364
          38313536363735643062653166393131356535333730643462303862626137333064656362633831
          37333064303764646535356338373237396433313138376639636466333331313764313137333331
          61666439623235353137316630316336383562336630393832626163393063396133393132323833
          36363266363733363732316537316564376439663533323364653432383233326362663230636562
          32633463383565323462396231373937643932666563626238366136333562396564363433376133
          64303834373336626233333662376161633864643939356461396561336536353463633835376330
          65636463323831373632653732383137336263383461346265353566666431303133393430316338
          30656264333434623661663337393764303765303530343030663532303165313538343431666633
          65373039393363663130646533656465363466653763353631656630346463306162623363313866
          31376233633163306632633632663135383036393337336531393937306638306666633934343764
          61643362333465313263646339323833373564636164666336636537653365353563643735396334
          37363534643931343936636237383639623537306564303737336137646166636164353764386238
          62623564633238393933653636653038343232653132623464646661366161303566326465653737
          36383063313238346564633332306538376234343831653034633836663931383037326464313534
          34336562653332323038343139376636353638313136373138353933343834386435663161626235
          38383464306135393835623366336437383236303437353538363362333463626565643733386430
          30373966336663313937336563303538313937396364393363613333363464353366336331366532
          66333534396136663933653033643134646439623464663034343830633635303933363161356465
          30343762616636333732393836656338643338653035366366663565646133386366643465346130
          30666430363961333531306563366365656636316439646665636635666664613433313439663931
          33626338633938386138326538613330643531646262313237386438343530396661613363363065
          31343639653132623463663730663837386466303234633139623531636231626365383663393763
          35643931373835613330303836663238393961363162393735313938646231663430363763366532
          30653462313466353536636636336463656262336531353362666565326638363134366662306265
          61653865353531643235666639633065366462326139363464343162616234643362353835356432
          33626337376232666439333663353363653033626564353731393864653931343763306366666264
          33336165366337363437326564366536306330663832376561326164623430376431633365366439
          65373032346130616462303638666536663164633166623537666366336437343136356431633330
          61633564653339303862313761666666633263373365356339643735373737616235303839396636
          66383966386339363830626538386533613537353035643730656531333234363436393733303966
          30343835303832623739353965646164633861656166313731323434363430323431643565343030
          39313335643662336337303937393039353731313034626631633331346466653136353730653366
          35313137303366656339313665316462313362643030323563363962643664333638356266313430
          62383939666232663235356137313839336563336232313136626264626132346635316261313835
          61613130663634366332656463393138646232363534396433383965373766353064376430353462
          34643465633839313836373363386636333333663730383530626161356333386362623338376463
          35356565386164333933663037653339396535313363623033373739366436366666646439633963
          32653238636532653331346361353264333364623931633032353339326463313666383735326338
          62636563316332626236363635396436303430303330666432303065373561396632326663656238
          35386336356338303066373938326465626661373538333964366663366532343933313435376464
          65616661343534353564366135303730633737666635373634653063353430343832363632656139
          34396138626334313663336530323030383433303266386639666264633530383262333239623836
          34346263666230353565316134376265376562653732656464343362323031613366366531616239
          30393863656234316565303363343132353031323866393761613935633338333165663262343134
          34366330643433643561623538366532383966366638353635323137326335393762626433626139
          62343230393838363637363963333536613331653438343831666262353364376130326563623436
          61343530343866383938633133383661666466303937666431393031343763616630306638326231
          33326361373933383033383734663630346266623135656431313166346139306433376164343265
          37316631633762666464303034346333656538353733653330396532623962376166316137303039
          33313039623733303331366336613535663062343664633734353934316431346566353531353362
          62313234613639326662306335363232646338313532313565353563363366636163333633373631
          31653535666437376139373639653764626566343837633938373333313034336233323238366334
          33396338313337363035616132653032333331306231376139623033333436666663366266643339
          63386333396665363839356266663062303061656362303832616662373365643464616636356130
          32613162613665363538326130643366336432343339383935633066356364393832333661366333
          64343030316165366437376562336130316361613831393037396439346237373635633661653664
          32316363316638323238613066363736333733663362313333663865346537613535323662353136
          33343536373434313331663963316133333533616438613939343835353936656237393137623232
          61373132323533643139343434333039393138643738666137373332366236323465363332303130
          37633331336132353762343738376263623565663536616165326635303165313531313138366262
          31323633633466643436376334353363636134346332303261646161383865333366363336383137
          36623030316163633138623739383139333162336264613237366163383533393335616261636634
          33376333393562356238316434316233366635393135373964656264383637396465626362653166
          37653830653133333261666538323264393364383935663531336232396163376437656537336534
          35303364303237343965306430393865393437363038323432353562366137326539323830376564
          66663764373636393132316463336461346334376363363961613934323363323631326232333961
          38623333616666623031363230373138383639376238363830333666643463623638633364643930
          39386637336665333633616531623131366364623336383635396538383636313432336561373365
          31616461633130326265633665353034373563636466346465663939626166616434373038396232
          65653163313831333463653533643961633237363335636138656636373136386136316363366332
          35313337343531363135383337623166346561636239663735643335383763633866393031386562
          63313836363962663939333434393566643936313564656339643339333761666437366563313430
          65636437653465636336393166626333356231353161383662366462633961316431626136613231
          31636562616364346163663133346264353933363566376266643636393934623630376161663466
          32336635623965663265353934313239393036316331303439343862383238633037646139643563
          32653631343861303963336563656335306231616463653362383566663134376464666464323661
          33396366363430623863316332346537376366306536623464373565636231653532383636613165
          30323036303462663761303336333164353038363137373936376638323233636236623761663439
          30333737396437653630353735633266376637653138303864363733323063333061313930313731
          61363538313536623561366236636664666637633835366466343363336165663561303366643430
          65636364653131313363643835373166346236343537653862353363333331633932326466356264
          31316635303233356131663833666230626631353630306239336133633735633463333866383665
          61336666336162393530396665346531623537633366616338663137623337313030373032346232
          3365646435646566303133333132616463303738383131313163
      when: not github_mini_rsa_stat.stat.exists
    - name: add identity to ssh config
      lineinfile:
        dest: ~/.ssh/config
        create: yes
        state: present
        line: IdentityFile ~/.ssh/github_mini_rsa
      when: not github_mini_rsa_stat.stat.exists
    - name: add github key to ssh
      shell: ssh-add ~/.ssh/github_mini_rsa
      when: not github_mini_rsa_stat.stat.exists

    # install pushover config
    - name: register .pushoverrc stat
      stat: path="~/.pushoverrc"
      register: pushoverrc_stat
    - name: install pushover config
      copy:
        dest: ~/.pushoverrc
        mode: 0600
        content: |
          $ANSIBLE_VAULT;1.1;AES256
          61303363653566643832353138343331333231656265373838666336666235646238396433653531
          3835653162643539656565326430323330656165653966350a383864643564383039373932336535
          31336238356137353130386565313337306132313633643166303961336230353934666636303863
          3333643535393532630a363530353937343438323435333630313937363765626332326138656464
          66396537366664343264396263646139376231386135343533306566363262356231333661653163
          39613537336161653334336637643937666139313162353739323366613261326563613738313934
          34613262646434356437313164366633363366313731373962626163666137306638613739323761
          36343034353736383538373062373165646439353434393937373764666563653032353532376634
          66616139326233393963323030323831646138396339316336386435393132616234393235326231
          30663939363032656538653537366234326236333366646337303562383837376635616237643563
          35393437316665386132326662626332613531303366363137306236633861323562306230326630
          66326263646464666263393366636662613131653562643863666333373363626639623461633238
          36333766333036303736316530663735613030666262643834653338356462323631386335663738
          6131346534363332626632643461653532623963613934393831
      when: not pushoverrc_stat.stat.exists

    # setup bash profile
    - name: register .profile stat
      stat: path="~/.profile"
      register: profile_stat
    - name: setup .profile
      copy: src="files/.profile" dest="~"
      when: not profile_stat.stat.exists

    # set finder to not show hard disks
    - name: register ShowHardDisks
      shell: /usr/libexec/PlistBuddy -c "print :systemitems:ShowHardDisks" ~/Library/Preferences/com.apple.sidebarlists.plist
      register: showharddisks_default
      changed_when: false
      ignore_errors: yes
    - name: set ShowHardDisks
      shell: /usr/libexec/PlistBuddy -c "set :systemitems:ShowHardDisks NO" ~/Library/Preferences/com.apple.sidebarlists.plist
      when: showharddisks_default.stdout != 'NO'

    # set finder toolbar items
    - name: check for toolbar configuration dict
      shell: /usr/libexec/PlistBuddy -c "print :'NSToolbar Configuration Browser'" ~/Library/Preferences/com.apple.finder.plist
      register: toolbar_configuration_check_result
      changed_when: false
      ignore_errors: yes
    - name: add toolbar configuration dict
      shell: /usr/libexec/PlistBuddy -c "add :'NSToolbar Configuration Browser' dict" ~/Library/Preferences/com.apple.finder.plist
      when: toolbar_configuration_check_result.rc
    - name: check for toolbar item settings array
      shell: /usr/libexec/PlistBuddy -c "print :'NSToolbar Configuration Browser:TB Item Identifiers'" ~/Library/Preferences/com.apple.finder.plist
      register: toolbar_check_result
      changed_when: false
      ignore_errors: yes
    - name: add toolbar item settings array
      shell: /usr/libexec/PlistBuddy -c "add :'NSToolbar Configuration Browser:TB Item Identifiers' array" ~/Library/Preferences/com.apple.finder.plist
      when: toolbar_check_result.rc
    - name: add toolbar item setting entries
      shell: /usr/libexec/PlistBuddy -c "add :'NSToolbar Configuration Browser:TB Item Identifiers:' string '{{ item }}'" ~/Library/Preferences/com.apple.finder.plist
      when: toolbar_check_result.rc
      with_items:
        - com.apple.finder.BACK
        - NSToolbarFlexibleSpaceItem
        - com.apple.finder.SWCH
        - com.apple.finder.PATH
        - NSToolbarSpaceItem
        - com.apple.finder.SHAR
        - com.apple.finder.ACTN
        - NSToolbarFlexibleSpaceItem
        - NSToolbarFlexibleSpaceItem
        - com.apple.finder.SRCH

    # set finder toolbar items to item only
    - name: register toolbar display mode
      shell: /usr/libexec/PlistBuddy -c "print :'NSToolbar Configuration Browser:TB Display Mode'" ~/Library/Preferences/com.apple.finder.plist
      register: tbdisplaymode_default
      changed_when: false
      ignore_errors: yes
    - name: set toolbar display mode
      shell: /usr/libexec/PlistBuddy -c "add :'NSToolbar Configuration Browser:TB Display Mode' integer 2" ~/Library/Preferences/com.apple.finder.plist
      when: tbdisplaymode_default.stdout != '2'

    # set finder icon view settings
    - name: set finder icon view settings
      shell: /usr/libexec/PlistBuddy -c "set :'StandardViewSettings:IconViewSettings:{{ item.property }}' {{ item.value }}" ~/Library/Preferences/com.apple.finder.plist
      with_items:
        - property: gridSpacing
          value: 30
        - property: textSize
          value: 12
        - property: showItemInfo
          value: false
        - property: iconSize
          value: 44
        # 'name' really maps to 'sort by'
        - property: arrangeBy
          value: name

    # set finder desktop view settings
    - name: set finder desktop view settings
      shell: /usr/libexec/PlistBuddy -c "set :'DesktopViewSettings:IconViewSettings:{{ item.property }}' {{ item.value }}" ~/Library/Preferences/com.apple.finder.plist
      with_items:
        - property: gridSpacing
          value: 25
        - property: textSize
          value: 12
        - property: iconSize
          value: 44
        - property: arrangeBy
          value: grid

    - name: set OS X defaults
      osx_defaults: domain={{ item.domain }} key={{ item.key }} type={{ item.type }} value={{ item.value }}
      with_items:
        # set tap-to-click
        - domain: NSGlobalDomain
          key: com.apple.mouse.tapBehavior
          type: integer
          value: 1
        # set output sound when changing volume
        - domain: NSGlobalDomain
          key: com.apple.sound.beep.feedback
          type: integer
          value: 1

        - domain: 'NSGlobalDomain'
          key: 'NSTableViewDefaultSizeMode'
          type: integer
          value: 1
        - domain: 'NSGlobalDomain'
          key: 'NSNavPanelExpandedStateForSaveMode'
          type: boolean
          value: true
        - domain: 'NSGlobalDomain'
          key: 'AppleActionOnDoubleClick'
          type: string
          value: 'Minimize'

        # screen saver
        - domain: 'com.apple.screensaver'
          key: 'askForPassword'
          type: integer
          value: 0

        # set tabbing between all UI elements
        - domain: 'NSGlobalDomain'
          key: 'AppleKeyboardUIMode'
          type: integer
          value: 2

        # clock
        - domain: 'com.apple.menuextra.clock'
          key: 'IsAnalog'
          type: integer
          value: 1

        # finder
        - domain: 'com.apple.finder'
          key: 'ShowTabView'
          type: boolean
          value: true
        - domain: 'com.apple.finder'
          key: 'ShowRecentTags'
          type: boolean
          value: false
        - domain: 'com.apple.finder'
          key: 'ShowExternalHardDrivesOnDesktop'
          type: boolean
          value: false
        - domain: 'com.apple.finder'
          key: 'ShowHardDrivesOnDesktop'
          type: boolean
          value: false
        - domain: 'com.apple.finder'
          key: 'NewWindowFilePath'
          type: string
          value: 'file:///Users/marcus/'

        # dock
        - domain: 'com.apple.dock'
          key: 'autohide'
          type: boolean
          value: true
        - domain: 'com.apple.dock'
          key: 'minimize-to-application'
          type: boolean
          value: true
        - domain: 'com.apple.dock'
          key: 'show-process-indicators'
          type: boolean
          value: true
        - domain: 'com.apple.dock'
          key: 'tilesize'
          type: float
          value: 55
        - domain: 'com.apple.dock'
          key: 'wvous-tl-corner'
          type: integer
          value: 10
        - domain: 'com.apple.dock'
          key: 'wvous-tl-modifier'
          type: integer
          value: 0
        - domain: 'com.apple.dock'
          key: 'wvous-tr-corner'
          type: integer
          value: 4
        - domain: 'com.apple.dock'
          key: 'wvous-tr-modifier'
          type: integer
          value: 0

        # set mouse settings
        - domain: 'com.apple.driver.AppleHIDMouse'
          key: 'Button2'
          type: integer
          value: 2
        - domain: 'com.apple.driver.AppleHIDMouse'
          key: 'ButtonDominance'
          type: integer
          value: 1

        # trackpad
        - domain: 'com.apple.driver.AppleBluetoothMultitouch.trackpad'
          key: 'Clicking'
          type: integer
          value: 1
        - domain: 'com.apple.AppleMultitouchTrackpad'
          key: 'Clicking'
          type: integer
          value: 1
        - domain: 'com.apple.dock'
          key: 'showAppExposeGestureEnabled'
          type: integer
          value: 1

    - name: set OS X defaults for currentHost
      osx_defaults: host=currentHost domain={{ item.domain }} key={{ item.key }} type={{ item.type }} value={{ item.value }}
      with_items:
        # set tap-to-click
        - domain: NSGlobalDomain
          key: com.apple.mouse.tapBehavior
          type: integer
          value: 1
